# Pyroscope Helm Chart Values
# This chart deploys Grafana Pyroscope with Cloudflare Tunnel exposure
#
# Pyroscope is a continuous profiling backend for storing and querying
# CPU, memory, and performance profiles from your applications.

namespace: ""
name: ""

image: grafana/pyroscope
tag: "1.13.5"

# Infisical integration - secrets sync from Infisical (source of truth)
# When enabled, InfisicalSecret CRD creates K8s Secret automatically
infisical:
  enabled: false
  hostAPI: "https://vault.dockify.app/api"
  projectId: ""           # Organization's Infisical project UUID
  environment: "dev"      # Infisical environment slug
  secretPath: ""          # Path in Infisical (e.g., /pyroscope/deployment-name)
  resyncInterval: 15      # Sync every 15 seconds
  credentialsSecretName: "infisical-machine-identity"
  credentialsNamespace: "infisical-system"

# Resource allocation
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# Persistent storage for profiles
storage:
  size: 10Gi
  storageClass: ""  # Uses default if empty

# Cloudflare Tunnel configuration
tunnel:
  enabled: true
  fqdn: ""  # e.g., myapp-pyroscope.dockify.cloud
  clusterTunnel: s1-dockify-cloud-tunnel

# Internal service (ClusterIP)
service:
  type: ClusterIP
  port: 4040

# Pod Disruption Budget
pdb:
  enabled: true
  minAvailable: 0  # Allow drain for single replica deployments

# Pyroscope configuration
config:
  # Authentication (basic auth via nginx sidecar)
  auth:
    enabled: false
    # Credentials stored in Infisical secret when enabled

  # Retention settings
  retention:
    minFreeDiskGb: 1  # Minimum free disk space to maintain
    enforcementInterval: 5m

  # Limits
  limits:
    maxLabelNamesPerSeries: 30
    maxSessionsPerSeries: 16
