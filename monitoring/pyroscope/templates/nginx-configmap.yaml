{{- if .Values.config.auth.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.name }}-nginx-config
  namespace: {{ .Values.namespace }}
  labels:
    app: {{ .Values.name }}
    app.kubernetes.io/name: pyroscope
    app.kubernetes.io/instance: {{ .Values.name }}
    app.kubernetes.io/managed-by: dockify
data:
  nginx.conf: |
    worker_processes 1;
    error_log /dev/stderr warn;
    pid /tmp/nginx.pid;

    events {
      worker_connections 1024;
    }

    http {
      client_body_temp_path /tmp/client_temp;
      proxy_temp_path /tmp/proxy_temp;
      fastcgi_temp_path /tmp/fastcgi_temp;
      uwsgi_temp_path /tmp/uwsgi_temp;
      scgi_temp_path /tmp/scgi_temp;

      access_log /dev/stdout;
      sendfile on;
      keepalive_timeout 65;

      server {
        listen 8080;
        server_name _;

        # Health check endpoint - no auth required
        location /ready {
          proxy_pass http://127.0.0.1:4040/ready;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
        }

        # Ingest endpoint for profile data (requires auth)
        location /ingest {
          auth_basic "Pyroscope";
          auth_basic_user_file /etc/nginx/auth/.htpasswd;

          proxy_pass http://127.0.0.1:4040/ingest;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Connection "";

          # Allow larger payloads for profile data
          client_max_body_size 10m;

          # Timeouts for profile ingestion
          proxy_read_timeout 60s;
          proxy_connect_timeout 10s;
        }

        # All other endpoints require basic auth (Query API)
        location / {
          auth_basic "Pyroscope";
          auth_basic_user_file /etc/nginx/auth/.htpasswd;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          proxy_pass http://127.0.0.1:4040;
          proxy_http_version 1.1;
          proxy_set_header Connection "";

          # Timeouts for long-running queries (flame graph rendering)
          proxy_read_timeout 300s;
          proxy_connect_timeout 10s;
        }
      }
    }
{{- end }}
